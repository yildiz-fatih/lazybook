<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>profile - lazybook</title>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <div class="top-bar">
        <a href="./index.html">lazybook</a>
        <button id="logout-button">logout</button>
    </div>

    <h1 id="name-info"></h1>
    <p id="status-info"></p>

    <!-- Only visible on your own profile -->
    <form id="status-form" style="display:none">
        change status: <input id="status-input">
        <input id="submit" type="submit" value="save">
    </form>
    <hr>

    <div id="follows-info"></div>

    <hr>
    <h3>followers</h3>
    <div id="followers"></div>

    <hr>
    <h3>following</h3>
    <div id="following"></div>

    <hr>
    <h3>posts</h3>
    <!-- Only visible on your own profile -->
    <form id="post-form" style="display:none">
        <textarea id="post-contents" maxlength="1024" placeholder="say something..."
            style="width:50%;height:75px;"></textarea><br>
        <button id="post-submit" type="submit">post</button>
    </form>

    <br>

    <div id="user-posts"></div>

    <script src="./config.js"></script>
    <script src="./common.js"></script>
    <script>
        document.getElementById('logout-button').addEventListener('click', () => {
            removeToken();
            location.replace('./index.html');
        });

        const userId = new URLSearchParams(location.search).get('user_id');

        async function init() {
            if (!getToken()) {
                window.location.replace('./login.html');
                return;
            }

            if (!userId) { return; }

            const profileResponse = await authFetch(`${window.env.API_BASE}/users/${userId}`);
            if (profileResponse.status === 404) {
                alert('user not found')
                return;
            }
            if (!profileResponse.ok) { return; }

            const profile = await profileResponse.json();

            document.getElementById('status-info').textContent = profile.status || '';
            document.getElementById('name-info').textContent = profile.username;

            if (profile.relationship.is_self) {
                const statusInput = document.getElementById('status-input');
                const statusForm = document.getElementById('status-form');
                const postForm = document.getElementById('post-form');

                statusInput.value = profile.status || '';
                statusForm.style.display = "block";
                postForm.style.display = "";

                statusForm.onsubmit = async (e) => {
                    e.preventDefault();

                    const statusValue = document.getElementById('status-input').value.trim();

                    const updateStatusResponse = await authFetch(`${window.env.API_BASE}/users/${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: statusValue })
                    });

                    if (!updateStatusResponse.ok) {
                        alert('failed to update status');
                        return;
                    }

                    init();
                }

                postForm.onsubmit = async (e) => {
                    e.preventDefault();

                    const contents = document.getElementById('post-contents').value.trim();
                    if (!contents) { return; }

                    const createPostResponse = await authFetch(`${window.env.API_BASE}/posts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents })
                    });
                    if (!createPostResponse.ok) {
                        alert('failed to create post');
                        return;
                    }

                    postForm.reset();

                    init();
                }
            } else {
                // follow / unfollow + chat link
                const followsDiv = document.getElementById('follows-info');
                followsDiv.innerHTML = '';

                if (profile.relationship.follows_me) {
                    const p = document.createElement('p');
                    p.textContent = 'follows you';
                    followsDiv.appendChild(p);
                }

                const followButton = document.createElement('button');
                followButton.textContent = profile.relationship.i_follow ? 'unfollow' : 'follow';
                followButton.addEventListener("click", async () => {
                    const options = {
                        method: profile.relationship.i_follow ? "DELETE" : "POST",
                    };

                    const followToggleResponse = await authFetch(`${window.env.API_BASE}/users/${userId}/follow`, options);
                    if (!followToggleResponse.ok) {
                        alert('follow action failed');
                        return;
                    }

                    init();
                });
                followsDiv.appendChild(followButton);

                // chat link
                const chatLink = document.createElement('a');
                chatLink.href = `./chat.html?peer_id=${userId}`;
                chatLink.textContent = 'chat';
                chatLink.style.marginLeft = '6px';
                followsDiv.appendChild(chatLink);
            }

            // followers / following
            const types = ["followers", "following"];

            for (const type of types) {
                const followsDiv = document.getElementById(type);
                followsDiv.innerHTML = '';

                const usersListResponse = await authFetch(`${window.env.API_BASE}/users/${userId}/${type}`);
                if (!usersListResponse.ok) {
                    alert(`failed to load ${type}`);
                    continue;
                }

                const users = await usersListResponse.json();
                for (const user of users) {
                    const a = document.createElement('a');
                    a.href = `./profile.html?user_id=${user.id}`;
                    a.textContent = user.username;
                    followsDiv.appendChild(a);
                }
            }

            // posts
            const postsResponse = await authFetch(`${window.env.API_BASE}/users/${userId}/posts`);
            if (!postsResponse.ok) { return; }
            const posts = await postsResponse.json();

            const postsDiv = document.getElementById('user-posts');
            postsDiv.innerHTML = '';
            for (const post of posts) { postsDiv.appendChild(renderPost(post)); }
        }

        init();
    </script>
</body>

</html>